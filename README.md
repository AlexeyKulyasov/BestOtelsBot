# BestOtelsBot
***
BestOtelsBot - это Telegram-бот для анализа сайта Hotels.com и поиска
подходящих пользователю отелей.  

Бот написан с использованием библиотеки [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI) и доработанной
библиотеки [telebot-calendar](https://github.com/FlymeDllVa/telebot-calendar). Доработанная библиотека включена в
состав BestOtelsBot как `bot-calendar.py`. Подробности в docstrings библиотеки. 

## Предварительные установки/настройки
1. Перед началом работы необходимо выполнить установку необходимых для работы бота пакетов:
    ```shell script
    pip install -r requirements.txt
    ```
2. Создать файл .env. и прописать туда токены (телеграм бота и X-RapidAPI-Key). Шаблон файла находится в .env.dist.

## Описание работы бота
Бот получает запрашиваемую информацию о отелях с сайта Hotels.com посредством API Hotels, который расположен на
сайте [rapidapi.com](https://rapidapi.com/). После обработки результата api запроса, бот отправляет найденную информацию
пользователю.   

Для использования бота существует 4 команды:
+ `/help` - вывод справочной информации о командах бота
+ `/lowprice` - топ самых дешёвых отелей в городе
+ `/highprice` - топ самых дорогих отелей в городе
+ `/bestdeal` - самые дешёвые и находятся ближе всего к центру   

На любом шаге выполнения каждой команды у пользователя есть возможность запустить другую команду или прервать текущую
кнопкой "отмена" (под полем ввода).   

Формат вывода результата по каждой команде одинаковый. Для каждого отеля в выводе, пользователю отправляется сообщение
содержащее фото отеля и основную по нему информацию. В случае, если url фото отеля будет недоступен, вместо него будет
отправлено схематичное фото отеля из файла "debug_data/hotel.png".   

Также при любых ошибках возникающих в процессе выполнения api запросов, пользователь получит уведомление о невозможности
выполнить данную операцию сейчас.

### Особенности работы команды `bestdeal`
Для выполнения команды, у пользователя помимо прочих параметров запрашивается диапазон расстояния,
на котором находится отель от центра. Если правая граница полученного диапазона будет меньше, чем у отеля
с самым минимальным расстоянием от центра, то на обработку в качестве полученного списка отелей будут отправлены
первые N отелей, где N - кол-во запрашиваемых отелей в выводе.   

И наоборот, если левая граница будет больше, чем у отеля с самым максимальным расстоянием от центра
(перебираются все существующие страницы), то на обработку будут отправлены последние N - отелей.   

*Примечание: api запрос для получения списка отелей по команде "bestdeal" выполняется с указанием сортировки по
расстоянию от центра города и диапазону заданной цены.*   

Если api запрос вернет список отелей, в котором не будет ни одного отеля с обозначенным расстоянием от центра города, 
тогда будет выполнен ещё один api запрос с теми же параметрами, но с сортировкой по цене (аналогично команде "lowprice").
Полученный результат будет возвращен пользователю.

Во всех нестандартных случаях пользователю будет показано примечание о результатах вывода.   

В стандартном случае, в список для дальнейшей обработки попадут все отели, в независимости на каком кол-ве страниц
будут расположены отели удовлетворяющие параметрам запроса пользователя.   

### Тест логики работы команды `bestdeal`
В папке "tests" расположен тест класса отвечающий за логику выбора отелей из результата api запроса исходя из заданного
диапазона расстояний. В качестве тестовых данных используются json файлы в папке "debug_data". Тесты покрывают 9
различных сценариев расположения запрашиваемых данных в пределах 3-х страниц.   

Для проведения самостоятельного тестирования по тестовым данным, бот имеет возможность запуска в режиме отладки
(раздел "Запуск бота в тестовом режиме").   
А для удобства понимания, в каких пределах вводить числа для указания диапазона расстояний, можно использовать информацию
из файла "debug_data/data_from_files_by_range_price.txt".  

## Запуск бота
Бот запускается командой `python main.py` из корневой папки проекта. 

## Запуск бота в тестовом режиме
`python main.py --debug`   

В этом режиме можно проводить тестирование работы бота не используя api запросы. Данные для обработки будут получены из
json файлов из папки "debug_data".   
Для тестирования загрузки локаций при поиске города нужно указать город заданный в
параметре "DEBUG_NAME_CITY" файла "config.py", в этом случае, бот загрузит локации из файла "locations.json".   
А при выводе результатов поиска (тут уже не зависимо от города) по командам "/lowprice" и "/highprice" будет
использовать данные из файлов "hotels_low_price.json" или "hotels_high_price.json" в зависимости от команды.   
Для тестирования команды "bestdeal" используются три файла hotels_by_range_price_N.json, где N - [1:3]. Совокупность
данных из трех файлов имитирует данные из последовательных страниц получаемых по api запросам.   

*Примечание: т.к. в тестовых файлах находятся данные из результатов ранее сформированных api запросов, то по очевидным
причинам некоторые запрашиваемые параметры в тестовом режиме будут игнорироваться и заменяться данными из файлов.*
 
## Логирование
Бот имеет два логера:
1. Логер встроенный в библиотеку pyTelegramBotAPI, регистрирующий все обращения к api телеграму.
2. Логер самого бота, логирующий различные состояния самого приложения, ошибки обращения к api rapidapi.com и ошибки
парсинга результата запроса. 

Каждый логер пишет все события в свой файл, с ротацией по времени 24 часа и хранит журналы за последние пять суток.
Дополнительно, логер бота все события выше уровня INFO пишет ещё в консоль.    

## Demo
![](demo.gif)